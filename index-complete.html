<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會議室預約系統</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Google Sheets API 設定
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAtuebA9bZ-UJz9rxPDjtJIggh-yp2_uITrgC_V8A-gpp-biCM9o2JdPgtBfuqNMtN4A/exec';
        
        // Icon Components
        const Calendar = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );
        const Clock = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );
        const X = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );
        const Plus = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );
        const Download = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );
        const Trash2 = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );
        const ChevronLeft = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        );
        const ChevronRight = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );
        const RefreshCw = ({ className, ...props }) => (
            <svg className={className} {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        // Google Sheets Storage API
        window.storage = {
            async get(key) {
                if (key !== 'meeting-bookings') {
                    const value = localStorage.getItem(key);
                    return value ? { key, value } : null;
                }
                
                try {
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll`, {
                        method: 'GET',
                        redirect: 'follow'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        return {
                            key: key,
                            value: JSON.stringify(data.bookings)
                        };
                    }
                } catch (error) {
                    console.error('從 Google Sheets 讀取資料失敗:', error);
                    alert('無法連接到資料庫，請檢查網路連線或稍後再試');
                }
                return null;
            },
            
            async set(key, value) {
                if (key === 'meeting-bookings-last-saved') {
                    localStorage.setItem(key, value);
                    return { key, value };
                }
                return { key, value };
            },
            
            async delete(key) {
                localStorage.removeItem(key);
                return { key, deleted: true };
            },
            
            async addBooking(booking) {
                try {
                    // 使用 Google Apps Script 需要用特殊方式發送 POST
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'add',
                            booking: booking
                        }),
                        redirect: 'follow'
                    });
                    
                    // no-cors 模式下無法讀取回應，所以我們假設成功
                    // 然後重新載入資料來驗證
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 等待 1 秒讓 Google Sheets 更新
                    return true;
                } catch (error) {
                    console.error('新增預約失敗:', error);
                    return false;
                }
            },
            
            async deleteBooking(id) {
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'delete',
                            id: id
                        }),
                        redirect: 'follow'
                    });
                    
                    // no-cors 模式下無法讀取回應，所以我們假設成功
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 等待 1 秒讓 Google Sheets 更新
                    return true;
                } catch (error) {
                    console.error('刪除預約失敗:', error);
                    return false;
                }
            }
        };

        const MeetingRoomBooking = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [bookings, setBookings] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [viewMode, setViewMode] = useState('month');
            const [selectedRoom, setSelectedRoom] = useState('all');
            const [loading, setLoading] = useState(true);
            const [lastSaved, setLastSaved] = useState(null);
            const [showBackupModal, setShowBackupModal] = useState(false);
            const [refreshing, setRefreshing] = useState(false);

            const rooms = [
                { id: 'large', name: '台北辦公室大會議室', color: '#3b82f6' },
                { id: 'small', name: '台北辦公室小會議室', color: '#10b981' }
            ];

            const timeSlots = [];
            for (let hour = 7; hour < 20; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
            }
            timeSlots.push('20:00');

            const [formData, setFormData] = useState({
                room: 'large',
                date: '',
                startTime: '09:00',
                endTime: '09:30',
                purpose: '',
                bookedBy: '',
                participants: ''
            });

            useEffect(() => {
                loadBookings();
            }, []);

            const loadBookings = async () => {
                setLoading(true);
                try {
                    const result = await window.storage.get('meeting-bookings');
                    if (result && result.value) {
                        const loadedBookings = JSON.parse(result.value);
                        console.log('載入的預約資料:', loadedBookings);
                        
                        // 確保日期格式正確
                        const formattedBookings = loadedBookings.map(booking => ({
                            ...booking,
                            date: typeof booking.date === 'string' ? booking.date : String(booking.date),
                            startTime: typeof booking.startTime === 'string' ? booking.startTime : String(booking.startTime),
                            endTime: typeof booking.endTime === 'string' ? booking.endTime : String(booking.endTime),
                        }));
                        
                        const twoMonthsAgo = new Date();
                        twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                        const twoMonthsAgoStr = formatDate(twoMonthsAgo);
                        
                        const validBookings = formattedBookings.filter(b => b.date >= twoMonthsAgoStr);
                        console.log('有效的預約資料:', validBookings);
                        console.log('總共載入', validBookings.length, '筆預約');
                        
                        setBookings(validBookings);
                    } else {
                        console.log('沒有找到預約資料');
                        setBookings([]);
                    }
                    
                    const savedTime = await window.storage.get('meeting-bookings-last-saved');
                    if (savedTime && savedTime.value) {
                        setLastSaved(savedTime.value);
                    }
                } catch (error) {
                    console.error('載入預約資料時發生錯誤:', error);
                    setBookings([]);
                } finally {
                    setLoading(false);
                }
            };

            const refreshBookings = async () => {
                setRefreshing(true);
                await loadBookings();
                setTimeout(() => setRefreshing(false), 500);
            };

            const saveBooking = async (newBooking) => {
                try {
                    const success = await window.storage.addBooking(newBooking);
                    if (success) {
                        // 等待 Google Sheets 更新完成後重新載入
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        await loadBookings();
                        const now = new Date().toISOString();
                        await window.storage.set('meeting-bookings-last-saved', now);
                        setLastSaved(now);
                        return true;
                    } else {
                        alert('儲存預約失敗，請稍後再試');
                        return false;
                    }
                } catch (error) {
                    console.error('儲存預約失敗:', error);
                    alert('儲存預約失敗，請檢查網路連線');
                    return false;
                }
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                return { daysInMonth, startingDayOfWeek, year, month };
            };

            const formatDate = (date) => {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            const getBookingsForDate = (date) => {
                const dateStr = formatDate(date);
                console.log('正在查詢日期:', dateStr);
                const result = bookings.filter(b => {
                    console.log('比對預約:', b.date, '===', dateStr, '?', b.date === dateStr);
                    return b.date === dateStr;
                });
                console.log('查詢結果:', result);
                return result;
            };

            const getBookingColor = (booking) => {
                const room = rooms.find(r => r.id === booking.room);
                return room ? room.color : '#6b7280';
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!formData.purpose || !formData.bookedBy) {
                    alert('請填寫使用目的和預約人');
                    return;
                }

                if (formData.startTime >= formData.endTime) {
                    alert('結束時間必須晚於開始時間');
                    return;
                }

                const bookingDate = new Date(formData.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const threeMonthsLater = new Date(today);
                threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
                
                if (bookingDate < today) {
                    alert('無法預約過去的日期');
                    return;
                }
                
                if (bookingDate > threeMonthsLater) {
                    alert('只能預約未來三個月內的會議室');
                    return;
                }

                const conflicts = bookings.filter(b => 
                    b.date === formData.date &&
                    b.room === formData.room &&
                    ((formData.startTime >= b.startTime && formData.startTime < b.endTime) ||
                     (formData.endTime > b.startTime && formData.endTime <= b.endTime) ||
                     (formData.startTime <= b.startTime && formData.endTime >= b.endTime))
                );

                if (conflicts.length > 0) {
                    alert('此時段已被預約，請選擇其他時間');
                    return;
                }

                const newBooking = {
                    id: Date.now().toString(),
                    ...formData,
                    createdAt: new Date().toISOString()
                };

                // 顯示載入中
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = '儲存中...';
                submitButton.disabled = true;

                const success = await saveBooking(newBooking);
                
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                
                if (success) {
                    alert('預約成功！資料已同步到雲端');
                    setIsModalOpen(false);
                    resetForm();
                }
            };

            const deleteBooking = async (id) => {
                if (window.confirm('確定要取消此預約嗎？')) {
                    const success = await window.storage.deleteBooking(id);
                    if (success) {
                        // 等待 Google Sheets 更新完成後重新載入
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        await loadBookings();
                        const now = new Date().toISOString();
                        await window.storage.set('meeting-bookings-last-saved', now);
                        setLastSaved(now);
                    } else {
                        alert('取消預約失敗，請稍後再試');
                    }
                }
            };

            const resetForm = () => {
                setFormData({
                    room: 'large',
                    date: '',
                    startTime: '09:00',
                    endTime: '09:30',
                    purpose: '',
                    bookedBy: '',
                    participants: ''
                });
            };

            const exportToICS = (booking) => {
                const room = rooms.find(r => r.id === booking.room);
                const startDateTime = new Date(`${booking.date}T${booking.startTime}:00`);
                const endDateTime = new Date(`${booking.date}T${booking.endTime}:00`);
                
                const formatICSDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Meeting Room Booking System//EN
BEGIN:VEVENT
UID:${booking.id}@meetingroom
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(startDateTime)}
DTEND:${formatICSDate(endDateTime)}
SUMMARY:${booking.purpose}
DESCRIPTION:預約人: ${booking.bookedBy}${booking.participants ? '\\n參與者: ' + booking.participants : ''}
LOCATION:${room.name}
STATUS:CONFIRMED
END:VEVENT
END:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `meeting-${booking.id}.ics`;
                link.click();
            };

            const openGoogleCalendar = (booking) => {
                const room = rooms.find(r => r.id === booking.room);
                const startDateTime = new Date(`${booking.date}T${booking.startTime}:00`);
                const endDateTime = new Date(`${booking.date}T${booking.endTime}:00`);
                
                const formatGoogleDate = (date) => {
                    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                const details = `預約人: ${booking.bookedBy}${booking.participants ? '\n參與者: ' + booking.participants : ''}`;
                
                const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(booking.purpose)}&dates=${formatGoogleDate(startDateTime)}/${formatGoogleDate(endDateTime)}&details=${encodeURIComponent(details)}&location=${encodeURIComponent(room.name)}`;
                
                window.open(url, '_blank');
            };

            const exportToCSV = () => {
                let csv = '\uFEFF';
                csv += '會議室,日期,開始時間,結束時間,使用目的,預約人,參與者,預約時間\n';
                
                bookings.sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.startTime.localeCompare(b.startTime);
                }).forEach(booking => {
                    const room = rooms.find(r => r.id === booking.room);
                    csv += `"${room?.name || booking.room}","${booking.date}","${booking.startTime}","${booking.endTime}","${booking.purpose}","${booking.bookedBy}","${booking.participants || ''}","${new Date(booking.createdAt).toLocaleString('zh-TW')}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `會議室預約清單_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const openBookingModal = (date, time = '09:00') => {
                setFormData({
                    ...formData,
                    date: formatDate(date),
                    startTime: time,
                    endTime: timeSlots[timeSlots.indexOf(time) + 1] || '20:00'
                });
                setIsModalOpen(true);
            };

            const formatLastSaved = (timestamp) => {
                if (!timestamp) return '未知';
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return '剛剛';
                if (diffMins < 60) return `${diffMins} 分鐘前`;
                
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours} 小時前`;
                
                return date.toLocaleString('zh-TW');
            };

            const { daysInMonth, startingDayOfWeek, year, month } = getDaysInMonth(currentDate);

            const changeMonth = (delta) => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + delta, 1));
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-slate-600 font-medium">載入中...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-4 md:p-8">
                    <style>{`
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Outfit:wght@600;700&display=swap');
                        
                        * {
                            font-family: 'Noto Sans TC', sans-serif;
                        }
                        
                        .booking-card {
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        }
                        
                        .booking-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
                        }
                        
                        .time-slot {
                            transition: all 0.2s ease;
                        }
                        
                        .time-slot:hover {
                            background-color: rgba(59, 130, 246, 0.05);
                            border-color: rgba(59, 130, 246, 0.3);
                        }
                        
                        .calendar-day {
                            transition: all 0.2s ease;
                        }
                        
                        .calendar-day:hover {
                            background-color: rgba(255, 255, 255, 0.8);
                            transform: scale(1.05);
                        }
                        
                        .modal-backdrop {
                            animation: fadeIn 0.2s ease;
                        }
                        
                        .modal-content {
                            animation: slideUp 0.3s ease;
                        }
                        
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        
                        @keyframes slideUp {
                            from {
                                opacity: 0;
                                transform: translateY(20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                        
                        .room-badge {
                            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
                        }
                        
                        @keyframes pulse {
                            0%, 100% {
                                opacity: 1;
                            }
                            50% {
                                opacity: 0.8;
                            }
                        }

                        @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                        }
                        
                        .animate-spin-slow {
                            animation: spin 1s linear infinite;
                        }
                    `}</style>

                    <div className="max-w-7xl mx-auto">
                        <div className="mb-8 text-center">
                            <h1 className="text-4xl md:text-5xl font-bold text-slate-800 mb-3" style={{ fontFamily: 'Outfit, sans-serif' }}>
                                會議室預約系統
                            </h1>
                            <p className="text-slate-600 text-lg">雲端同步 • 多人共用 • 即時更新</p>
                        </div>

                        <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-6">
                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={() => changeMonth(-1)}
                                        className="p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                    >
                                        <ChevronLeft className="w-5 h-5 text-slate-600" />
                                    </button>
                                    <h2 className="text-2xl font-bold text-slate-800 min-w-[200px] text-center">
                                        {year}年 {month + 1}月
                                    </h2>
                                    <button
                                        onClick={() => changeMonth(1)}
                                        className="p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                    >
                                        <ChevronRight className="w-5 h-5 text-slate-600" />
                                    </button>
                                </div>

                                <div className="flex flex-wrap items-center gap-3">
                                    <select
                                        value={selectedRoom}
                                        onChange={(e) => setSelectedRoom(e.target.value)}
                                        className="px-4 py-2 border border-slate-200 rounded-lg bg-white text-slate-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">所有會議室</option>
                                        {rooms.map(room => (
                                            <option key={room.id} value={room.id}>{room.name}</option>
                                        ))}
                                    </select>

                                    <div className="flex gap-2 bg-slate-100 rounded-lg p-1">
                                        <button
                                            onClick={() => setViewMode('month')}
                                            className={`px-4 py-2 rounded-md font-medium transition-all ${
                                                viewMode === 'month'
                                                    ? 'bg-white text-blue-600 shadow-sm'
                                                    : 'text-slate-600 hover:text-slate-800'
                                            }`}
                                        >
                                            月視圖
                                        </button>
                                        <button
                                            onClick={() => setViewMode('day')}
                                            className={`px-4 py-2 rounded-md font-medium transition-all ${
                                                viewMode === 'day'
                                                    ? 'bg-white text-blue-600 shadow-sm'
                                                    : 'text-slate-600 hover:text-slate-800'
                                            }`}
                                        >
                                            日視圖
                                        </button>
                                    </div>

                                    <button
                                        onClick={refreshBookings}
                                        disabled={refreshing}
                                        className="flex items-center gap-2 bg-green-600 text-white px-4 py-2.5 rounded-lg hover:bg-green-700 transition-all shadow-md hover:shadow-lg font-medium disabled:opacity-50"
                                        title="重新整理"
                                    >
                                        <RefreshCw className={`w-5 h-5 ${refreshing ? 'animate-spin-slow' : ''}`} />
                                        重新整理
                                    </button>

                                    <button
                                        onClick={() => setShowBackupModal(true)}
                                        className="flex items-center gap-2 bg-slate-600 text-white px-4 py-2.5 rounded-lg hover:bg-slate-700 transition-all shadow-md hover:shadow-lg font-medium"
                                        title="匯出資料"
                                    >
                                        <Download className="w-5 h-5" />
                                        匯出
                                    </button>

                                    <button
                                        onClick={() => openBookingModal(selectedDate)}
                                        className="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-2.5 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg font-medium"
                                    >
                                        <Plus className="w-5 h-5" />
                                        新增預約
                                    </button>
                                </div>
                            </div>
                            
                            <div className="mt-3 flex items-center justify-between text-xs text-slate-500">
                                <div>
                                    最後更新：{formatLastSaved(lastSaved)} | 共 {bookings.length} 筆預約
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                    <span>雲端同步</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 mb-6">
                            <h3 className="text-sm font-semibold text-slate-600 mb-3 uppercase tracking-wider">會議室</h3>
                            <div className="flex flex-wrap gap-4">
                                {rooms.map(room => (
                                    <div key={room.id} className="flex items-center gap-3 px-4 py-2 bg-slate-50 rounded-lg">
                                        <div className="w-4 h-4 rounded-full room-badge" style={{ backgroundColor: room.color }}></div>
                                        <div className="font-medium text-slate-800">{room.name}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {viewMode === 'month' ? (
                            <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6">
                                {/* 除錯信息 */}
                                {console.log('=== 月視圖渲染 ===')}
                                {console.log('當前 bookings 狀態:', bookings)}
                                {console.log('bookings 數量:', bookings.length)}
                                
                                <div className="grid grid-cols-7 gap-2 mb-4">
                                    {['日', '一', '二', '三', '四', '五', '六'].map((day, i) => (
                                        <div key={i} className="text-center font-bold text-slate-700 py-2">
                                            {day}
                                        </div>
                                    ))}
                                </div>

                                <div className="grid grid-cols-7 gap-2">
                                    {Array.from({ length: startingDayOfWeek }).map((_, i) => (
                                        <div key={`empty-${i}`} className="min-h-[120px]"></div>
                                    ))}
                                    
                                    {Array.from({ length: daysInMonth }).map((_, i) => {
                                        const day = i + 1;
                                        const date = new Date(year, month, day);
                                        const dateBookings = getBookingsForDate(date);
                                        const filteredBookings = selectedRoom === 'all' 
                                            ? dateBookings 
                                            : dateBookings.filter(b => b.room === selectedRoom);
                                        const isToday = formatDate(date) === formatDate(new Date());
                                        const isSelected = formatDate(date) === formatDate(selectedDate);

                                        // 除錯：顯示 20 號的預約情況
                                        if (day === 20) {
                                            console.log('20號日期:', formatDate(date));
                                            console.log('20號的預約:', dateBookings);
                                            console.log('所有預約資料:', bookings);
                                        }

                                        return (
                                            <div
                                                key={day}
                                                onClick={() => {
                                                    setSelectedDate(date);
                                                    setViewMode('day');
                                                }}
                                                className={`calendar-day p-2 rounded-xl cursor-pointer border-2 min-h-[120px] ${
                                                    isToday
                                                        ? 'border-blue-500 bg-blue-50'
                                                        : isSelected
                                                        ? 'border-indigo-400 bg-indigo-50'
                                                        : 'border-slate-200 bg-white'
                                                }`}
                                            >
                                                <div className={`text-sm font-semibold mb-1 ${
                                                    isToday ? 'text-blue-600' : 'text-slate-700'
                                                }`}>
                                                    {day}
                                                </div>
                                                <div className="space-y-1">
                                                    {filteredBookings.slice(0, 3).map((booking, idx) => (
                                                        <div
                                                            key={idx}
                                                            className="text-xs px-1.5 py-0.5 rounded truncate text-white font-medium"
                                                            style={{ backgroundColor: getBookingColor(booking) }}
                                                            title={`${booking.startTime.slice(0, 5)} ${booking.purpose}`}
                                                        >
                                                            {booking.startTime.slice(0, 5)} {booking.purpose}
                                                        </div>
                                                    ))}
                                                    {filteredBookings.length > 3 && (
                                                        <div className="text-xs text-slate-500 font-medium">
                                                            +{filteredBookings.length - 3}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6">
                                <div className="mb-6 flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <button
                                            onClick={() => setSelectedDate(new Date(selectedDate.getTime() - 86400000))}
                                            className="p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                        >
                                            <ChevronLeft className="w-5 h-5 text-slate-600" />
                                        </button>
                                        <h3 className="text-2xl font-bold text-slate-800">
                                            {selectedDate.getFullYear()}年 {selectedDate.getMonth() + 1}月 {selectedDate.getDate()}日
                                        </h3>
                                        <button
                                            onClick={() => setSelectedDate(new Date(selectedDate.getTime() + 86400000))}
                                            className="p-2 hover:bg-slate-100 rounded-lg transition-colors"
                                        >
                                            <ChevronRight className="w-5 h-5 text-slate-600" />
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setSelectedDate(new Date())}
                                        className="px-4 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                    >
                                        今天
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {rooms.filter(room => selectedRoom === 'all' || room.id === selectedRoom).map(room => (
                                        <div key={room.id} className="border-2 border-slate-200 rounded-xl p-4">
                                            <div className="flex items-center gap-3 mb-4 pb-3 border-b-2 border-slate-100">
                                                <div className="w-3 h-3 rounded-full" style={{ backgroundColor: room.color }}></div>
                                                <h4 className="font-bold text-lg text-slate-800">{room.name}</h4>
                                            </div>

                                            <div className="space-y-2 max-h-[600px] overflow-y-auto">
                                                {timeSlots.map((time, idx) => {
                                                    if (idx === timeSlots.length - 1) return null;
                                                    
                                                    const nextTime = timeSlots[idx + 1];
                                                    const booking = bookings.find(b =>
                                                        b.date === formatDate(selectedDate) &&
                                                        b.room === room.id &&
                                                        b.startTime === time
                                                    );

                                                    return (
                                                        <div
                                                            key={time}
                                                            className={`time-slot p-3 rounded-lg border-2 cursor-pointer ${
                                                                booking
                                                                    ? 'border-transparent'
                                                                    : 'border-slate-200 hover:border-blue-300'
                                                            }`}
                                                            style={booking ? {
                                                                backgroundColor: `${getBookingColor(booking)}15`,
                                                                borderColor: getBookingColor(booking)
                                                            } : {}}
                                                            onClick={() => !booking && openBookingModal(selectedDate, time)}
                                                        >
                                                            <div className="flex items-start justify-between">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        <Clock className="w-4 h-4 text-slate-500" />
                                                                        <span className="text-sm font-semibold text-slate-700">
                                                                            {time} - {nextTime}
                                                                        </span>
                                                                    </div>
                                                                    {booking ? (
                                                                        <div className="ml-6 space-y-1">
                                                                            <div className="font-medium text-slate-800">{booking.purpose}</div>
                                                                            <div className="text-sm text-slate-600">預約人: {booking.bookedBy}</div>
                                                                            {booking.participants && (
                                                                                <div className="text-sm text-slate-600">參與者: {booking.participants}</div>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <div className="ml-6 text-sm text-slate-400">可預約</div>
                                                                    )}
                                                                </div>
                                                                {booking && (
                                                                    <div className="flex gap-2">
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                exportToICS(booking);
                                                                            }}
                                                                            className="p-1.5 hover:bg-white rounded transition-colors"
                                                                            title="匯出到 Outlook"
                                                                        >
                                                                            <Download className="w-4 h-4 text-blue-600" />
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                openGoogleCalendar(booking);
                                                                            }}
                                                                            className="p-1.5 hover:bg-white rounded transition-colors"
                                                                            title="加入 Google 日曆"
                                                                        >
                                                                            <Calendar className="w-4 h-4 text-green-600" />
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                deleteBooking(booking.id);
                                                                            }}
                                                                            className="p-1.5 hover:bg-red-50 rounded transition-colors"
                                                                            title="取消預約"
                                                                        >
                                                                            <Trash2 className="w-4 h-4 text-red-600" />
                                                                        </button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {isModalOpen && (
                        <div className="modal-backdrop fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="modal-content bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-2xl font-bold">新增會議室預約</h3>
                                        <button
                                            onClick={() => {
                                                setIsModalOpen(false);
                                                resetForm();
                                            }}
                                            className="p-2 hover:bg-white/20 rounded-lg transition-colors"
                                        >
                                            <X className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>

                                <form onSubmit={handleSubmit} className="p-6 space-y-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                                            會議室 *
                                        </label>
                                        <select
                                            value={formData.room}
                                            onChange={(e) => setFormData({ ...formData, room: e.target.value })}
                                            className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                            required
                                        >
                                            {rooms.map(room => (
                                                <option key={room.id} value={room.id}>
                                                    {room.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                                            預約日期 *
                                        </label>
                                        <input
                                            type="date"
                                            value={formData.date}
                                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                            className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                            required
                                        />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                                                開始時間 *
                                            </label>
                                            <select
                                                value={formData.startTime}
                                                onChange={(e) => {
                                                    const newStart = e.target.value;
                                                    const startIdx = timeSlots.indexOf(newStart);
                                                    setFormData({
                                                        ...formData,
                                                        startTime: newStart,
                                                        endTime: timeSlots[startIdx + 1] || '20:00'
                                                    });
                                                }}
                                                className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                                required
                                            >
                                                {timeSlots.slice(0, -1).map(time => (
                                                    <option key={time} value={time}>{time}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                                                結束時間 *
                                            </label>
                                            <select
                                                value={formData.endTime}
                                                onChange={(e) => setFormData({ ...formData, endTime: e.target.value })}
                                                className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                                required
                                            >
                                                {timeSlots.filter(t => t > formData.startTime).map(time => (
                                                    <option key={time} value={time}>{time}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                                            使用目的 *
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.purpose}
                                            onChange={(e) => setFormData({ ...formData, purpose: e.target.value })}
                                            placeholder="例：部門會議、客戶簡報..."
                                            className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                                            預約人 *
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.bookedBy}
                                            onChange={(e) => setFormData({ ...formData, bookedBy: e.target.value })}
                                            placeholder="您的姓名"
                                            className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">
                                            參與者 (選填)
                                        </label>
                                        <input
                                            type="text"
                                            value={formData.participants}
                                            onChange={(e) => setFormData({ ...formData, participants: e.target.value })}
                                            placeholder="例：張三、李四、王五"
                                            className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                        />
                                    </div>

                                    <div className="flex gap-3 pt-4">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setIsModalOpen(false);
                                                resetForm();
                                            }}
                                            className="flex-1 px-6 py-3 border-2 border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors font-medium"
                                        >
                                            取消
                                        </button>
                                        <button
                                            type="submit"
                                            className="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg font-medium"
                                        >
                                            確認預約
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showBackupModal && (
                        <div className="modal-backdrop fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="modal-content bg-white rounded-2xl shadow-2xl max-w-2xl w-full">
                                <div className="sticky top-0 bg-gradient-to-r from-slate-700 to-slate-600 text-white p-6 rounded-t-2xl">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-2xl font-bold">匯出預約資料</h3>
                                        <button
                                            onClick={() => setShowBackupModal(false)}
                                            className="p-2 hover:bg-white/20 rounded-lg transition-colors"
                                        >
                                            <X className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>

                                <div className="p-6 space-y-6">
                                    <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                        <div className="flex items-start gap-3">
                                            <div className="text-green-700">
                                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-green-900 mb-1">雲端同步啟用中</h4>
                                                <p className="text-sm text-green-800">
                                                    您的資料已儲存在 Google Sheets，所有人共用同一份資料，不會遺失！
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="border-2 border-slate-200 rounded-xl p-4 hover:border-green-300 transition-colors">
                                            <h4 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                                <Download className="w-5 h-5 text-green-600" />
                                                匯出 Excel 清單
                                            </h4>
                                            <p className="text-sm text-slate-600 mb-3">
                                                下載所有預約的 CSV 檔案，可用 Excel 開啟查看和列印
                                            </p>
                                            <button
                                                onClick={exportToCSV}
                                                className="w-full bg-green-600 text-white px-4 py-2.5 rounded-lg hover:bg-green-700 transition-colors font-medium"
                                            >
                                                匯出 Excel 清單 (.csv)
                                            </button>
                                        </div>
                                    </div>

                                    <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                        <p className="text-sm text-blue-800">
                                            <strong>💡 提示：</strong><br/>
                                            • 資料已自動儲存在 Google Sheets<br/>
                                            • 可直接在 Google Sheets 查看所有預約<br/>
                                            • 匯出 CSV 用於列印或其他用途
                                        </p>
                                    </div>

                                    <button
                                        onClick={() => setShowBackupModal(false)}
                                        className="w-full px-6 py-3 border-2 border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors font-medium"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MeetingRoomBooking />);
    </script>
</body>
</html>